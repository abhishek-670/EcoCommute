{% extends "rides/base.html" %}

{% block head %}
<!-- Leaflet.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
<!-- Leaflet.js JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="{% url 'rides_list' %}" class="inline-flex items-center text-green-600 hover:text-green-700 font-medium">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Back to Rides
        </a>
    </div>

    <!-- Ride Details Card -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-4">
            <h2 class="text-2xl font-bold text-white flex items-center">
                <svg class="w-7 h-7 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Ride Details
            </h2>
        </div>
        
        <div class="p-6">
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Route Information -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Route Information</h3>
                    
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-3 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                        </svg>
                        <div>
                            <p class="text-sm text-gray-500">From - To</p>
                            <p class="text-gray-900 font-medium">{{ ride.from_location }} ‚Üí {{ ride.to_location }}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-3 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <div>
                            <p class="text-sm text-gray-500">Date</p>
                            <p class="text-gray-900 font-medium">{{ ride.ride_date }}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-3 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <p class="text-sm text-gray-500">Time</p>
                            <p class="text-gray-900 font-medium">{{ ride.ride_time|time:"H:i" }}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-3 text-gray-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                        <div>
                            <p class="text-sm text-gray-500">Distance</p>
                            <p class="text-gray-900 font-medium">{{ ride.distance_km }} km</p>
                        </div>
                    </div>
                </div>

                <!-- Ride Information -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Ride Information</h3>
                    
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-3 text-yellow-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                        </svg>
                        <div>
                            <p class="text-sm text-gray-500">Vehicle Type</p>
                            <p class="text-gray-900 font-medium">{% if ride.vehicle_type == 'car_petrol' %}Car (petrol){% else %}Bike{% endif %}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-3 text-indigo-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        <div>
                            <p class="text-sm text-gray-500">Vehicle Number</p>
                            <p class="text-gray-900 font-bold text-lg tracking-wider">{{ ride.vehicle_number }}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-3 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <div>
                            <p class="text-sm text-gray-500">Available Seats</p>
                            <p class="text-gray-900 font-medium">{{ ride.seats_available }}/{{ ride.total_seats }}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-3 text-gray-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <div>
                            <p class="text-sm text-gray-500">Driver</p>
                            <p class="text-gray-900 font-medium">{{ ride.creator.email }}</p>
                        </div>
                    </div>
                    
                    <!-- Ride Status Badge -->
                    <div class="pt-4 mt-4 border-t border-gray-200">
                        <p class="text-sm text-gray-500 mb-2">Ride Status</p>
                        {% if ride.ride_status == 'created' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                            </svg>
                            Waiting to Start
                        </span>
                        {% elif ride.ride_status == 'started' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            In Progress
                        </span>
                        {% elif ride.ride_status == 'completed' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-800">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            Completed
                        </span>
                        {% endif %}
                    </div>

                    {% if not is_creator and not has_joined and ride.seats_available > 0 and ride.ride_status == 'created' %}
                    <div class="pt-2">
                        <a href="{% url 'join_ride' ride.id %}" 
                           class="inline-block w-full text-center px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg hover:shadow-xl">
                            Join This Ride
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if is_creator and passengers %}
                    <!-- Track Passengers Button (Only for Ride Creator) -->
                    <div class="pt-2">
                        <a href="{% url 'track_ride' ride.id %}" 
                           class="inline-block w-full text-center px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg font-semibold hover:from-blue-600 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl">
                            <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                            </svg>
                            Track Passenger Locations
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if has_joined %}
                    <!-- Share Location Button (Only for Passengers) -->
                    <div class="pt-2">
                        <a href="{% url 'share_location_view' ride.id %}" 
                           class="inline-block w-full text-center px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg font-semibold hover:from-orange-600 hover:to-red-700 transition-all shadow-lg hover:shadow-xl">
                            <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Share My Location
                        </a>
                    </div>
                    {% endif %}
                    
                    <!-- Two-Side Confirmation Buttons -->
                    {% if ride.ride_status != 'completed' %}
                    <div class="pt-4 mt-4 border-t border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Ride Confirmation</h4>
                        
                        {% if is_creator %}
                        <!-- Driver Buttons -->
                        <div class="space-y-2">
                            {% if ride.ride_status == 'created' %}
                            <!-- Start Ride Button -->
                            <form method="POST" action="{% url 'driver_start_ride' ride.id %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" 
                                        {% if ride.driver_started %}disabled{% endif %}
                                        class="w-full px-4 py-2 rounded-lg font-medium transition-all {% if ride.driver_started %}bg-gray-300 text-gray-500 cursor-not-allowed{% else %}bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:from-green-600 hover:to-emerald-700 shadow-md hover:shadow-lg{% endif %}">
                                    {% if ride.driver_started %}
                                    ‚úÖ Start Confirmed (Waiting for Passenger)
                                    {% else %}
                                    üöó Start Ride
                                    {% endif %}
                                </button>
                            </form>
                            {% elif ride.ride_status == 'started' %}
                            <!-- End Ride Button -->
                            <form method="POST" action="{% url 'driver_end_ride' ride.id %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" 
                                        {% if ride.driver_ended %}disabled{% endif %}
                                        class="w-full px-4 py-2 rounded-lg font-medium transition-all {% if ride.driver_ended %}bg-gray-300 text-gray-500 cursor-not-allowed{% else %}bg-gradient-to-r from-red-500 to-pink-600 text-white hover:from-red-600 hover:to-pink-700 shadow-md hover:shadow-lg{% endif %}">
                                    {% if ride.driver_ended %}
                                    ‚úÖ End Confirmed (Waiting for Passenger)
                                    {% else %}
                                    üèÅ End Ride
                                    {% endif %}
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% elif has_joined %}
                        <!-- Passenger Buttons -->
                        <div class="space-y-2">
                            {% if ride.ride_status == 'created' %}
                            <!-- Confirm Start Button -->
                            <form method="POST" action="{% url 'passenger_confirm_start' ride.id %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" 
                                        {% if ride.passenger_started %}disabled{% endif %}
                                        class="w-full px-4 py-2 rounded-lg font-medium transition-all {% if ride.passenger_started %}bg-gray-300 text-gray-500 cursor-not-allowed{% else %}bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:from-blue-600 hover:to-indigo-700 shadow-md hover:shadow-lg{% endif %}">
                                    {% if ride.passenger_started %}
                                    ‚úÖ Start Confirmed (Waiting for Driver)
                                    {% else %}
                                    ‚úì Confirm Start
                                    {% endif %}
                                </button>
                            </form>
                            {% elif ride.ride_status == 'started' %}
                            <!-- Confirm Arrival Button -->
                            <form method="POST" action="{% url 'passenger_confirm_arrival' ride.id %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" 
                                        {% if ride.passenger_ended %}disabled{% endif %}
                                        class="w-full px-4 py-2 rounded-lg font-medium transition-all {% if ride.passenger_ended %}bg-gray-300 text-gray-500 cursor-not-allowed{% else %}bg-gradient-to-r from-purple-500 to-pink-600 text-white hover:from-purple-600 hover:to-pink-700 shadow-md hover:shadow-lg{% endif %}">
                                    {% if ride.passenger_ended %}
                                    ‚úÖ Arrival Confirmed (Waiting for Driver)
                                    {% else %}
                                    ‚úì Confirm Arrival
                                    {% endif %}
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Road Map Visualization (Start ‚Üí Pickup ‚Üí Destination) -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-blue-500 to-cyan-600 px-6 py-4">
            <h3 class="text-xl font-bold text-white flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                </svg>
                Route Map
            </h3>
        </div>
        
        <div class="p-6">
            <div id="routeMap" class="w-full h-96 rounded-lg border-2 border-gray-200 shadow-inner"></div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="flex items-center p-3 bg-green-50 rounded-lg border border-green-200">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold mr-3">A</div>
                    <div>
                        <p class="text-xs text-gray-600">Start Location</p>
                        <p class="font-semibold text-gray-900">{{ ride.from_location }}</p>
                    </div>
                </div>
                {% if passengers %}
                <div class="flex items-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold mr-3">B</div>
                    <div>
                        <p class="text-xs text-gray-600">Pickup Point(s)</p>
                        <p class="font-semibold text-gray-900">{{ passengers.0.pickup_point }}</p>
                    </div>
                </div>
                {% endif %}
                <div class="flex items-center p-3 bg-red-50 rounded-lg border border-red-200">
                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white font-bold mr-3">C</div>
                    <div>
                        <p class="text-xs text-gray-600">Destination</p>
                        <p class="font-semibold text-gray-900">{{ ride.to_location }}</p>
                    </div>
                </div>
            </div>
            <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                <p class="text-sm text-blue-800">
                    <svg class="inline-block w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    The route shown is an approximate visualization. For detailed navigation, please use GPS or maps.
                </p>
            </div>
        </div>
    </div>

    <!-- Passengers List -->
    {% if is_creator or has_joined %}
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 px-6 py-4">
            <h3 class="text-xl font-bold text-white flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                Passengers ({{ passengers.count }})
            </h3>
        </div>
        
        <div class="p-6">
            {% if passengers %}
                <div class="space-y-4">
                    {% for passenger in passengers %}
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-5 border border-purple-100">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center mb-3">
                                    <div class="bg-purple-200 rounded-full p-2 mr-3">
                                        <svg class="w-5 h-5 text-purple-700" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-900">{{ passenger.user.email }}</p>
                                        <p class="text-xs text-gray-500">Joined {{ passenger.joined_at|date:"M d, Y H:i" }}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-2 ml-12">
                                    <div class="flex items-start">
                                        <svg class="w-5 h-5 mr-2 text-purple-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        <div>
                                            <p class="text-sm font-medium text-gray-700">Pickup Point</p>
                                            <p class="text-gray-900 font-semibold">{{ passenger.pickup_point }}</p>
                                        </div>
                                    </div>
                                    
                                    {% if passenger.pickup_notes %}
                                    <div class="flex items-start">
                                        <svg class="w-5 h-5 mr-2 text-purple-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                        </svg>
                                        <div>
                                            <p class="text-sm font-medium text-gray-700">Notes</p>
                                            <p class="text-gray-900">{{ passenger.pickup_notes }}</p>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if is_creator and passenger.whatsapp_phone %}
                                    <!-- WhatsApp Notification Buttons (Creator Only) -->
                                    <div class="mt-3 flex flex-col sm:flex-row gap-2">
                                        <!-- Start Ride Button -->
                                        <a href="https://wa.me/{{ passenger.whatsapp_phone }}?text={{ passenger.start_ride_message|urlencode }}" 
                                           target="_blank"
                                           rel="noopener noreferrer"
                                           class="inline-flex items-center justify-center px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg font-medium transition-all shadow-sm hover:shadow-md">
                                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                            </svg>
                                            Start Ride ‚Äì Notify
                                        </a>
                                        
                                        <!-- General Notify Button -->
                                        <a href="https://wa.me/{{ passenger.whatsapp_phone }}?text={{ passenger.whatsapp_message|urlencode }}" 
                                           target="_blank"
                                           rel="noopener noreferrer"
                                           class="inline-flex items-center justify-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-colors shadow-sm hover:shadow-md">
                                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                            </svg>
                                            Send Details
                                        </a>
                                    </div>
                                    {% elif is_creator and not passenger.whatsapp_phone %}
                                    <!-- Warning for missing phone number -->
                                    <div class="mt-3">
                                        <div class="flex items-center px-4 py-2 bg-yellow-50 border border-yellow-200 rounded-lg">
                                            <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                            <span class="text-sm text-yellow-800">No phone number available for WhatsApp</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    <p class="text-gray-500">No passengers have joined yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
// Initialize the map
document.addEventListener('DOMContentLoaded', function() {
    // Create map centered on India (default view)
    var map = L.map('routeMap').setView([20.5937, 78.9629], 5);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
    }).addTo(map);
    
    // Sample coordinates - In a real app, these would be geocoded from location names
    // For demo purposes, using major Indian cities as examples
    var locations = {
        // Common Indian cities coordinates (you can add more)
        'Kochi': [9.9312, 76.2673],
        'Cochin': [9.9312, 76.2673],
        'Ernakulam': [9.9816, 76.2999],
        'Thiruvananthapuram': [8.5241, 76.9366],
        'Trivandrum': [8.5241, 76.9366],
        'Kozhikode': [11.2588, 75.7804],
        'Calicut': [11.2588, 75.7804],
        'Thrissur': [10.5276, 76.2144],
        'Kollam': [8.8932, 76.6141],
        'Palakkad': [10.7867, 76.6548],
        'Bangalore': [12.9716, 77.5946],
        'Bengaluru': [12.9716, 77.5946],
        'Mumbai': [19.0760, 72.8777],
        'Delhi': [28.7041, 77.1025],
        'Chennai': [13.0827, 80.2707],
        'Hyderabad': [17.3850, 78.4867],
        'Pune': [18.5204, 73.8567],
        'Ahmedabad': [23.0225, 72.5714],
        'Jaipur': [26.9124, 75.7873],
        'Lucknow': [26.8467, 80.9462],
        'Chandigarh': [30.7333, 76.7794],
        'Goa': [15.2993, 74.1240],
        'Mangalore': [12.9141, 74.8560],
        'Mysore': [12.2958, 76.6394],
        'Madurai': [9.9252, 78.1198],
        'Coimbatore': [11.0168, 76.9558],
        'Visakhapatnam': [17.6869, 83.2185],
        'Indore': [22.7196, 75.8577],
        'Bhopal': [23.2599, 77.4126],
        'Patna': [25.5941, 85.1376],
        'Vadodara': [22.3072, 73.1812],
        'Agra': [27.1767, 78.0081],
        'Nashik': [19.9975, 73.7898],
        'Varanasi': [25.3176, 82.9739],
        'Surat': [21.1702, 72.8311],
        'Rajkot': [22.3039, 70.8022],
    };
    
    // Get ride locations
    var fromLocation = "{{ ride.from_location }}".trim();
    var toLocation = "{{ ride.to_location }}".trim();
    {% if passengers %}
    var pickupLocation = "{{ passengers.0.pickup_point }}".trim();
    {% else %}
    var pickupLocation = null;
    {% endif %}
    
    // Helper function to find coordinates (case-insensitive, partial match)
    function getCoordinates(locationName) {
        locationName = locationName.toLowerCase();
        
        // First try exact match
        for (var key in locations) {
            if (key.toLowerCase() === locationName) {
                return locations[key];
            }
        }
        
        // Then try partial match (if location name contains city name)
        for (var key in locations) {
            if (locationName.includes(key.toLowerCase()) || key.toLowerCase().includes(locationName)) {
                return locations[key];
            }
        }
        
        return null;
    }
    
    // Get coordinates for each location
    var startCoords = getCoordinates(fromLocation);
    var endCoords = getCoordinates(toLocation);
    var pickupCoords = pickupLocation ? getCoordinates(pickupLocation) : null;
    
    // If we couldn't find coordinates, use defaults along a route
    if (!startCoords) {
        startCoords = [10.8505, 76.2711]; // Default: Kerala
    }
    if (!endCoords) {
        endCoords = [12.9716, 77.5946]; // Default: Bangalore
    }
    if (pickupLocation && !pickupCoords) {
        // Place pickup point midway between start and end
        pickupCoords = [
            (startCoords[0] + endCoords[0]) / 2,
            (startCoords[1] + endCoords[1]) / 2
        ];
    }
    
    // Create custom icons
    var startIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div style="background-color: #10b981; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">A</div>',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });
    
    var pickupIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div style="background-color: #3b82f6; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">B</div>',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });
    
    var endIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div style="background-color: #ef4444; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">C</div>',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });
    
    // Add markers
    var startMarker = L.marker(startCoords, {icon: startIcon}).addTo(map);
    startMarker.bindPopup('<div class="text-center"><strong class="text-green-600">Start</strong><br/>' + fromLocation + '</div>');
    
    var endMarker = L.marker(endCoords, {icon: endIcon}).addTo(map);
    endMarker.bindPopup('<div class="text-center"><strong class="text-red-600">Destination</strong><br/>' + toLocation + '</div>');
    
    // Build route coordinates array
    var routeCoords = [startCoords];
    
    if (pickupCoords) {
        var pickupMarker = L.marker(pickupCoords, {icon: pickupIcon}).addTo(map);
        pickupMarker.bindPopup('<div class="text-center"><strong class="text-blue-600">Pickup</strong><br/>' + pickupLocation + '</div>');
        routeCoords.push(pickupCoords);
    }
    
    routeCoords.push(endCoords);
    
    // Draw polyline connecting all points
    var polyline = L.polyline(routeCoords, {
        color: '#10b981',
        weight: 4,
        opacity: 0.7,
        dashArray: '10, 10',
        lineJoin: 'round'
    }).addTo(map);
    
    // Add direction arrows along the route
    var decorator = L.polylineDecorator(polyline, {
        patterns: [
            {
                offset: 25,
                repeat: 100,
                symbol: L.Symbol.arrowHead({
                    pixelSize: 12,
                    pathOptions: {
                        fillOpacity: 1,
                        weight: 0,
                        color: '#059669'
                    }
                })
            }
        ]
    });
    
    // Fit map to show all markers with padding
    var bounds = L.latLngBounds(routeCoords);
    map.fitBounds(bounds, {padding: [50, 50]});
    
    // Open start marker popup by default
    setTimeout(function() {
        startMarker.openPopup();
    }, 500);
});
</script>

<!-- Leaflet Polyline Decorator Plugin (for direction arrows) -->
<script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

{% endblock %}
