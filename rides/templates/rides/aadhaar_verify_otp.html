{% extends 'rides/base.html' %}

{% block title %}Enter OTP - EcoCommute{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Enter OTP</h1>
            <p class="text-gray-600">We've sent a 6-digit OTP to your Aadhaar-linked mobile number</p>
        </div>

        <!-- OTP Sent Confirmation -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <svg class="h-5 w-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-sm text-green-800">OTP sent successfully! Check your mobile phone.</span>
            </div>
        </div>

        <!-- OTP Input Form -->
        <form method="POST" action="{% url 'aadhaar_submit_otp' %}" class="space-y-6">
            {% csrf_token %}

            <!-- OTP Input -->
            <div>
                <label for="otp" class="block text-sm font-semibold text-gray-700 mb-3">
                    Enter 6-Digit OTP <span class="text-red-500">*</span>
                </label>
                <input 
                    type="text" 
                    id="otp" 
                    name="otp" 
                    maxlength="6"
                    pattern="[0-9]{6}"
                    placeholder="000000"
                    required
                    autofocus
                    autocomplete="off"
                    class="w-full px-6 py-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-2xl text-center tracking-widest font-mono"
                />
                <p class="mt-2 text-sm text-gray-600 text-center">
                    Enter the 6-digit code sent to your mobile
                </p>
            </div>

            <!-- Timer Display -->
            <div class="text-center">
                <p class="text-sm text-gray-600">
                    OTP valid for <span id="timer" class="font-semibold text-green-600">10:00</span> minutes
                </p>
            </div>

            <!-- Security Notice -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex">
                    <svg class="h-5 w-5 text-yellow-600 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <div class="text-sm text-yellow-800">
                        <p class="font-semibold">Security Tip:</p>
                        <ul class="list-disc list-inside mt-1 space-y-1">
                            <li>Never share your OTP with anyone</li>
                            <li>EcoCommute staff will never ask for your OTP</li>
                            <li>OTP is valid only for 10 minutes</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="space-y-3">
                <button 
                    type="submit" 
                    id="verify-btn"
                    class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 px-6 rounded-lg hover:from-green-600 hover:to-emerald-700 transition duration-200 shadow-lg flex items-center justify-center"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Verify OTP
                </button>

                <!-- Resend OTP Button -->
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2">Didn't receive OTP?</p>
                    <a 
                        href="{% url 'aadhaar_resend_otp' %}" 
                        id="resend-btn"
                        class="inline-flex items-center text-blue-600 hover:text-blue-700 font-semibold text-sm"
                    >
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Resend OTP
                    </a>
                    <p class="text-xs text-gray-500 mt-1">(Wait 30 seconds before resending)</p>
                </div>

                <!-- Cancel Button -->
                <a 
                    href="{% url 'aadhaar_verification_start' %}" 
                    class="block w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition duration-200 text-center"
                >
                    Cancel & Go Back
                </a>
            </div>
        </form>

        <!-- Help Section -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h3 class="font-semibold text-gray-900 mb-3">Troubleshooting</h3>
            <div class="space-y-2 text-sm text-gray-600">
                <p><strong>OTP not received?</strong></p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li>Check your SMS inbox for messages from UIDAI/verification provider</li>
                    <li>Wait for 1-2 minutes, SMS delivery can be delayed</li>
                    <li>Ensure your mobile number is linked to your Aadhaar</li>
                    <li>Click "Resend OTP" to try again</li>
                </ul>
                <p class="mt-3"><strong>Wrong OTP error?</strong></p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li>Double-check the 6-digit code</li>
                    <li>Make sure you're using the latest OTP (if you requested multiple times)</li>
                    <li>OTP is case-sensitive (though usually all numbers)</li>
                </ul>
            </div>
        </div>

        <!-- Contact Support -->
        <div class="mt-6 p-4 bg-gray-100 rounded-lg text-center text-sm text-gray-600">
            <p>Still having issues? Contact support at <a href="mailto:support@ecocommute.com" class="text-blue-600 underline font-semibold">support@ecocommute.com</a></p>
        </div>
    </div>
</div>

<script>
// Auto-focus on OTP input
document.getElementById('otp').focus();

// Only allow numbers in OTP input
document.getElementById('otp').addEventListener('input', function(e) {
    this.value = this.value.replace(/\D/g, '').slice(0, 6);
});

// Auto-submit when 6 digits entered (optional)
document.getElementById('otp').addEventListener('input', function(e) {
    if (this.value.length === 6) {
        // Optional: Auto-submit after 500ms
        // setTimeout(() => document.querySelector('form').submit(), 500);
    }
});

// Countdown timer (10 minutes)
let timeLeft = 600; // 10 minutes in seconds
const timerElement = document.getElementById('timer');
const resendBtn = document.getElementById('resend-btn');
let resendCooldown = 30; // 30 seconds cooldown before allowing resend

// Disable resend button initially
resendBtn.style.pointerEvents = 'none';
resendBtn.style.opacity = '0.5';

const countdown = setInterval(() => {
    timeLeft--;
    
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Enable resend after cooldown
    resendCooldown--;
    if (resendCooldown <= 0 && resendBtn.style.pointerEvents === 'none') {
        resendBtn.style.pointerEvents = 'auto';
        resendBtn.style.opacity = '1';
    }
    
    // Timer expired
    if (timeLeft <= 0) {
        clearInterval(countdown);
        timerElement.textContent = 'EXPIRED';
        timerElement.classList.add('text-red-600');
        document.getElementById('verify-btn').disabled = true;
        document.getElementById('verify-btn').classList.add('opacity-50', 'cursor-not-allowed');
        
        alert('OTP has expired. Please request a new OTP.');
    }
    
    // Warning at 2 minutes
    if (timeLeft === 120) {
        timerElement.classList.add('text-orange-600', 'font-bold');
    }
}, 1000);

// Prevent form double submission
let formSubmitted = false;
document.querySelector('form').addEventListener('submit', function(e) {
    if (formSubmitted) {
        e.preventDefault();
        return false;
    }
    
    const otp = document.getElementById('otp').value;
    if (otp.length !== 6) {
        e.preventDefault();
        alert('Please enter a 6-digit OTP');
        return false;
    }
    
    formSubmitted = true;
    document.getElementById('verify-btn').disabled = true;
    document.getElementById('verify-btn').innerHTML = '<svg class="animate-spin h-5 w-5 mr-2 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Verifying...';
});
</script>
{% endblock %}
